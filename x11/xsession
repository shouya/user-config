#!/bin/bash

export PATH=/home/shou/.asdf/shims:/home/shou/.asdf/bin:/home/shou/.cargo/bin:/home/shou/.local/bin:/home/shou/.cabal/bin:/home/shou/.shell/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin

exec 2> ~/.xsession-errors > ~/.xsession-log

# xresources
[ -f ~/.Xresources ] && xrdb -merge ~/.Xresources
# turn off audible bell
xset b off
# start screensaver (i3lock) after 10 minutes, and do not blank the
# screen. required for IdleAction for logind.
xset s 600
xset s noblank
# turn off screen/monitor/video signal after 5 mins of inactivity
xset dpms 300 300 300

# automatically swap ctrl/capslock on pluggable keyboards
~/.xmonad/scripts/new-keyboard.sh
inputplug -0 --command ~/.xmonad/scripts/new-keyboard.sh &

# pointer configs
~/.xmonad/scripts/touchpad-natural-scroll.sh

# compatibility configs
export XDG_CURRENT_DESKTOP=GNOME
# See https://blog.ando.fyi/posts/diagnosing-an-unsual-wifi-issue/
export QT_BEARER_POLL_TIMEOUT=-1

# external monitor setup
command -v mons && mons -e right || true

# set wallpaper
feh --bg-fill ~/Pictures/wallpapers/ -zr

# hidpi setting for gtk 3 apps
export GDK_SCALE=2
export GDK_DPI_SCALE=0.5

# Fix blank Java apps
export _JAVA_AWT_WM_NONREPARENTING=1

# compositor
picom --daemon

# status bar
# polybar --reload default-bar &
# TODO: fix eww. sometimes it just won't start on boot.
eww open main-window &

# network manager applet
(sleep 1; nm-applet) &

# clipboard
copyq &
autocutsel -fork

# pulseaudio control
pasystray &

# autokey
autokey &

# screensaver
# --transfer-sleep-lock is needed for i3lock to work with systemd
#
# use custom built i3lock that passes media key to wm (https://github.com/Raymo111/i3lock-color)
xss-lock --transfer-sleep-lock -- \
         ~/.local/bin/i3lock --nofork \
         --tiling --clock --show-failed-attempts \
         --date-color=999999 --time-color=aaaaaa \
         --date-size=30 --time-size=60\
         --pass-media-key --pass-screen-key \
         -i ~/Pictures/lockscreen.png &

# gnome keyring
export $(gnome-keyring-daemon --start)

exec 1<> /tmp/xmonad.stdout
exec 2<> /tmp/xmonad.stderr

if [[ -z "$DBUS_SESSION_BUS_ADDRESS" ]]; then
	exec dbus-launch --exit-with-session xmonad
else
	exec xmonad
fi
